{% extends "base.html" %}

{% block title %}Auto Berndl - Fahrzeugübersicht{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-header h1 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .header-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* Search Section */
    .search-section {
        background-color: var(--card-bg);
        padding: 1.25rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .search-section .input-group {
        max-width: 500px;
    }

    /* Table Container */
    .table-container {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .table-responsive {
        max-height: calc(100vh - 350px);
        min-height: 400px;
        overflow: auto;
    }

    /* Table Styles */
    .table {
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table thead th {
        background-color: #212529;
        color: white;
        font-weight: 600;
        white-space: nowrap;
        padding: 0.875rem 0.75rem;
        border: none;
        vertical-align: middle;
    }

    [data-bs-theme="dark"] .table thead th {
        background-color: #343a40;
    }

    .table tbody tr {
        transition: background-color 0.15s ease;
    }

    .table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .table tbody td {
        padding: 0.75rem;
        vertical-align: middle;
        border-color: var(--bs-border-color);
    }

    /* Sort Icons */
    .sort-header {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sort-header:hover {
        color: #6ea8fe;
    }

    .sort-icon {
        font-size: 0.75rem;
        opacity: 0.5;
    }

    .sort-icon.active {
        opacity: 1;
        color: #6ea8fe;
    }

    /* Action Column */
    .action-column {
        white-space: nowrap;
        width: 1%;
        position: sticky;
        right: 0;
        background-color: var(--card-bg);
        box-shadow: -4px 0 8px rgba(0,0,0,0.05);
    }

    .table thead th.action-column {
        background-color: #212529;
    }

    [data-bs-theme="dark"] .table thead th.action-column {
        background-color: #343a40;
    }

    .action-buttons {
        display: flex;
        gap: 0.25rem;
    }

    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    /* Features Cell */
    .features-cell {
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .features-cell:hover {
        white-space: normal;
        overflow: visible;
        position: relative;
        z-index: 5;
    }

    /* Price Cell */
    .price-cell {
        font-weight: 600;
        color: #198754;
        white-space: nowrap;
    }

    /* Badge Styles */
    .badge-vat {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }

    .badge-stock {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .badge-stock:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Sold row styling */
    tr.sold-car {
        opacity: 0.6;
        background-color: rgba(108, 117, 125, 0.1) !important;
    }

    tr.sold-car:hover {
        opacity: 0.8;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--bs-secondary-color);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        gap: 1.5rem;
        padding: 0.75rem 1rem;
        background-color: var(--bs-tertiary-bg);
        border-bottom: 1px solid var(--bs-border-color);
        font-size: 0.85rem;
    }

    .stats-bar .stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stats-bar .stat-value {
        font-weight: 600;
    }

    /* Pagination */
    .table-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--bs-border-color);
        background-color: var(--bs-tertiary-bg);
    }

    .table-footer .info {
        font-size: 0.85rem;
        color: var(--bs-secondary-color);
    }

    /* Modal Improvements */
    .modal-lg {
        max-width: 800px;
    }

    .edit-form .row {
        margin-bottom: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 991.98px) {
        .table-responsive {
            max-height: none;
        }
        
        .action-column {
            position: static;
            box-shadow: none;
        }
    }

    @media (min-width: 1400px) {
        .table {
            font-size: 0.95rem;
        }
    }

    /* Loading State */
    .table-loading {
        position: relative;
    }

    .table-loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
    }

    [data-bs-theme="dark"] .table-loading::after {
        background: rgba(26, 29, 33, 0.7);
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1>
        <i class="bi bi-list-ul text-primary"></i>
        Fahrzeugübersicht
    </h1>
    <div class="header-actions">
        <button class="btn btn-outline-secondary" onclick="exportToCSV()" title="Als CSV exportieren">
            <i class="bi bi-download me-1"></i>Export
        </button>
        <a href="{{ url_for('views.car_form') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>Neues Fahrzeug
        </a>
    </div>
</div>

<!-- Search Section -->
<div class="search-section">
    <form action="{{ url_for('views.view_cars') }}" method="GET" class="row g-3 align-items-center">
        <div class="col-auto flex-grow-1">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" name="search" value="{{ search_term }}"
                       placeholder="Suche nach Angebotsnummer, Marke, Modell..." autocomplete="off">
                <button class="btn btn-primary" type="submit">Suchen</button>
                {% if search_term %}
                    <a href="{{ url_for('views.view_cars') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- Table Container -->
<div class="table-container">
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat">
            <i class="bi bi-car-front"></i>
            <span class="stat-value">{{ cars|length }}</span>
            <span>Fahrzeuge</span>
        </div>
        {% if search_term %}
        <div class="stat">
            <i class="bi bi-funnel"></i>
            <span>Gefiltert nach: "{{ search_term }}"</span>
        </div>
        {% endif %}
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-hover" id="carsTable">
            <thead>
                <tr>
                    <th>
                        <a href="{{ url_for('views.view_cars', search=search_term, sort='id', order='desc' if sort_by == 'id' and sort_order == 'asc' else 'asc') }}" 
                           class="sort-header text-white text-decoration-none">
                            ID
                            <i class="bi bi-arrow-down-up sort-icon {% if sort_by == 'id' %}active{% endif %}"></i>
                        </a>
                    </th>
                    <th>
                        <a href="{{ url_for('views.view_cars', search=search_term, sort='listing_number', order='desc' if sort_by == 'listing_number' and sort_order == 'asc' else 'asc') }}"
                           class="sort-header text-white text-decoration-none">
                            Angebots-Nr.
                            <i class="bi bi-arrow-down-up sort-icon {% if sort_by == 'listing_number' %}active{% endif %}"></i>
                        </a>
                    </th>
                    <th>
                        <a href="{{ url_for('views.view_cars', search=search_term, sort='brand', order='desc' if sort_by == 'brand' and sort_order == 'asc' else 'asc') }}"
                           class="sort-header text-white text-decoration-none">
                            Marke
                            <i class="bi bi-arrow-down-up sort-icon {% if sort_by == 'brand' %}active{% endif %}"></i>
                        </a>
                    </th>
                    <th>Modell</th>
                    <th>Hubraum</th>
                    <th>Leistung</th>
                    <th>Kraftstoff</th>
                    <th>Getriebe</th>
                    <th>Kilometer</th>
                    <th>EZ</th>
                    <th>Ausstattung</th>
                    <th>Plakette</th>
                    <th>
                        <a href="{{ url_for('views.view_cars', search=search_term, sort='price', order='desc' if sort_by == 'price' and sort_order == 'asc' else 'asc') }}"
                           class="sort-header text-white text-decoration-none">
                            Preis
                            <i class="bi bi-arrow-down-up sort-icon {% if sort_by == 'price' %}active{% endif %}"></i>
                        </a>
                    </th>
                    <th>MwSt.</th>
                    <th>Status</th>
                    <th>
                        <a href="{{ url_for('views.view_cars', search=search_term, sort='created_at', order='desc' if sort_by == 'created_at' and sort_order == 'asc' else 'asc') }}"
                           class="sort-header text-white text-decoration-none">
                            Erstellt
                            <i class="bi bi-arrow-down-up sort-icon {% if sort_by == 'created_at' %}active{% endif %}"></i>
                        </a>
                    </th>
                    <th class="action-column">Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for car in cars %}
                <tr data-car-id="{{ car.id }}" class="{% if not car.in_stock %}sold-car{% endif %}">
                    <td>{{ car.id }}</td>
                    <td><strong>{{ car.listing_number }}</strong></td>
                    <td>{{ car.brand }}</td>
                    <td>{{ car.model }}</td>
                    <td>{{ car.engine_capacity }} ccm</td>
                    <td>{{ car.power }} PS</td>
                    <td>{{ car.fuel_type }}</td>
                    <td>{{ car.transmission }}</td>
                    <td>{{ car.mileage | numberformat }} km</td>
                    <td>{{ car.first_registration }}</td>
                    <td class="features-cell" title="{{ car.features }}">{{ car.features }}</td>
                    <td>{{ car.eco_badge }}</td>
                    <td class="price-cell">{{ car.price | numberformat }} €</td>
                    <td>
                        {% if car.vat_deductible %}
                            <span class="badge bg-success badge-vat">Ja</span>
                        {% else %}
                            <span class="badge bg-secondary badge-vat">Nein</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if car.in_stock %}
                            <span class="badge bg-success badge-stock toggle-stock" 
                                  data-car-id="{{ car.id }}" data-in-stock="true"
                                  title="Klicken um als verkauft zu markieren">
                                <i class="bi bi-check-circle me-1"></i>Im Bestand
                            </span>
                        {% else %}
                            <span class="badge bg-danger badge-stock toggle-stock" 
                                  data-car-id="{{ car.id }}" data-in-stock="false"
                                  title="Klicken um als im Bestand zu markieren">
                                <i class="bi bi-cart-check me-1"></i>Verkauft
                            </span>
                        {% endif %}
                    </td>
                    <td>{{ car.created_at.strftime('%d.%m.%Y') if car.created_at else '-' }}</td>
                    <td class="action-column">
                        <div class="action-buttons">
                            <button class="btn btn-outline-primary btn-sm edit-car" 
                                    data-car-id="{{ car.id }}" title="Bearbeiten">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <a href="{{ url_for('views.generate_car_pdf', car_id=car.id) }}" 
                               class="btn btn-outline-success btn-sm" title="PDF erstellen">
                                <i class="bi bi-file-pdf"></i>
                            </a>
                            <button class="btn btn-outline-danger btn-sm delete-car" 
                                    data-car-id="{{ car.id }}" title="Löschen">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="17">
                        <div class="empty-state">
                            <i class="bi bi-car-front d-block"></i>
                            <h5>Keine Fahrzeuge gefunden</h5>
                            {% if search_term %}
                                <p>Keine Ergebnisse für "{{ search_term }}"</p>
                                <a href="{{ url_for('views.view_cars') }}" class="btn btn-outline-primary">
                                    Filter zurücksetzen
                                </a>
                            {% else %}
                                <p>Es wurden noch keine Fahrzeuge angelegt.</p>
                                <a href="{{ url_for('views.car_form') }}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Erstes Fahrzeug anlegen
                                </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Table Footer -->
    {% if cars %}
    <div class="table-footer">
        <div class="info">
            Zeige {{ cars|length }} Fahrzeug{% if cars|length != 1 %}e{% endif %}
        </div>
        <div class="actions">
            <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                <i class="bi bi-printer me-1"></i>Drucken
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editCarModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil text-primary me-2"></i>Fahrzeug bearbeiten
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCarForm" class="edit-form">
                    <input type="hidden" id="editCarId">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Angebotsnummer</label>
                            <input type="text" class="form-control" id="editListingNumber" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Marke</label>
                            <input type="text" class="form-control" id="editBrand" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Modell</label>
                            <input type="text" class="form-control" id="editModel" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hubraum (ccm)</label>
                            <input type="number" class="form-control" id="editEngineCapacity">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Leistung (PS)</label>
                            <input type="number" class="form-control" id="editPower">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kraftstoff</label>
                            <select class="form-select" id="editFuelType">
                                <option value="Benzin">Benzin</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Elektro">Elektro</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="Plug-in-Hybrid">Plug-in-Hybrid</option>
                                <option value="Erdgas">Erdgas</option>
                                <option value="Autogas">Autogas</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Getriebe</label>
                            <select class="form-select" id="editTransmission">
                                <option value="Schaltgetriebe">Schaltgetriebe</option>
                                <option value="Automatik">Automatik</option>
                                <option value="Halbautomatik">Halbautomatik</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kilometer</label>
                            <input type="number" class="form-control" id="editMileage">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Erstzulassung</label>
                            <input type="text" class="form-control" id="editFirstRegistration" placeholder="MM/YYYY">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Sonderausstattung</label>
                            <textarea class="form-control" id="editFeatures" rows="3"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Umweltplakette</label>
                            <select class="form-select" id="editEcoBadge">
                                <option value="Grün (4)">Grün (4)</option>
                                <option value="Gelb (3)">Gelb (3)</option>
                                <option value="Rot (2)">Rot (2)</option>
                                <option value="Keine">Keine</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Preis (€)</label>
                            <input type="number" class="form-control" id="editPrice" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">MwSt. ausweisbar</label>
                            <select class="form-select" id="editVatDeductible">
                                <option value="true">Ja</option>
                                <option value="false">Nein</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editInStock">
                                <option value="true">Im Bestand</option>
                                <option value="false">Verkauft</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="saveCarChanges">
                    <i class="bi bi-check-lg me-1"></i>Speichern
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>Fahrzeug löschen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Möchten Sie dieses Fahrzeug wirklich löschen?</p>
                <p class="text-muted small">Diese Aktion kann nicht rückgängig gemacht werden.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="bi bi-trash me-1"></i>Löschen
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentCarId = null;
    const editModal = new bootstrap.Modal(document.getElementById('editCarModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteCarModal'));

    // Edit Car
    document.querySelectorAll('.edit-car').forEach(btn => {
        btn.addEventListener('click', async function() {
            const carId = this.dataset.carId;
            showLoading();
            
            try {
                const response = await fetch(`/car/${carId}`);
                const car = await response.json();
                
                if (car.error) {
                    throw new Error(car.error);
                }
                
                // Populate form
                document.getElementById('editCarId').value = car.id;
                document.getElementById('editListingNumber').value = car.listing_number || '';
                document.getElementById('editBrand').value = car.brand || '';
                document.getElementById('editModel').value = car.model || '';
                document.getElementById('editEngineCapacity').value = car.engine_capacity || '';
                document.getElementById('editPower').value = car.power || '';
                document.getElementById('editFuelType').value = car.fuel_type || 'Benzin';
                document.getElementById('editTransmission').value = car.transmission || 'Schaltgetriebe';
                document.getElementById('editMileage').value = car.mileage || '';
                document.getElementById('editFirstRegistration').value = car.first_registration || '';
                document.getElementById('editFeatures').value = car.features || '';
                document.getElementById('editEcoBadge').value = car.eco_badge || 'Grün (4)';
                document.getElementById('editPrice').value = car.price || '';
                document.getElementById('editVatDeductible').value = car.vat_deductible ? 'true' : 'false';
                document.getElementById('editInStock').value = car.in_stock ? 'true' : 'false';
                
                hideLoading();
                editModal.show();
            } catch (error) {
                hideLoading();
                showToast('Fehler beim Laden: ' + error.message, 'error');
            }
        });
    });

    // Save Changes
    document.getElementById('saveCarChanges').addEventListener('click', async function() {
        const carId = document.getElementById('editCarId').value;
        
        const data = {
            listing_number: document.getElementById('editListingNumber').value,
            brand: document.getElementById('editBrand').value,
            model: document.getElementById('editModel').value,
            engine_capacity: parseInt(document.getElementById('editEngineCapacity').value) || 0,
            power: parseInt(document.getElementById('editPower').value) || 0,
            fuel_type: document.getElementById('editFuelType').value,
            transmission: document.getElementById('editTransmission').value,
            mileage: parseInt(document.getElementById('editMileage').value) || 0,
            first_registration: document.getElementById('editFirstRegistration').value,
            features: document.getElementById('editFeatures').value,
            eco_badge: document.getElementById('editEcoBadge').value,
            price: parseInt(document.getElementById('editPrice').value) || 0,
            vat_deductible: document.getElementById('editVatDeductible').value === 'true',
            in_stock: document.getElementById('editInStock').value === 'true'
        };
        
        showLoading();
        
        try {
            const response = await fetch(`/car/${carId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            hideLoading();
            editModal.hide();
            showToast('Fahrzeug erfolgreich aktualisiert', 'success');
            
            // Reload page to show changes
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            hideLoading();
            showToast('Fehler beim Speichern: ' + error.message, 'error');
        }
    });

    // Delete Car
    document.querySelectorAll('.delete-car').forEach(btn => {
        btn.addEventListener('click', function() {
            currentCarId = this.dataset.carId;
            deleteModal.show();
        });
    });

    document.getElementById('confirmDelete').addEventListener('click', async function() {
        if (!currentCarId) return;
        
        showLoading();
        
        try {
            const response = await fetch(`/car/${currentCarId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            hideLoading();
            deleteModal.hide();
            showToast('Fahrzeug erfolgreich gelöscht', 'success');
            
            // Remove row from table
            const row = document.querySelector(`tr[data-car-id="${currentCarId}"]`);
            if (row) {
                row.remove();
            }
            
            currentCarId = null;
        } catch (error) {
            hideLoading();
            showToast('Fehler beim Löschen: ' + error.message, 'error');
        }
    });

    // Export to CSV
    async function exportToCSV() {
        showLoading();
        
        try {
            const response = await fetch('/api/cars/export');
            const cars = await response.json();
            
            if (cars.error) {
                throw new Error(cars.error);
            }
            
            // Create CSV content
            const headers = [
                'ID', 'Angebotsnummer', 'Marke', 'Modell', 'Hubraum', 'Leistung',
                'Kraftstoff', 'Getriebe', 'Kilometer', 'Erstzulassung', 'Ausstattung',
                'Umweltplakette', 'Preis', 'MwSt. ausweisbar', 'Verkäufer', 'Erstellt'
            ];
            
            const rows = cars.map(car => [
                car.id,
                car.listing_number,
                car.brand,
                car.model,
                car.engine_capacity,
                car.power,
                car.fuel_type,
                car.transmission,
                car.mileage,
                car.first_registration,
                `"${(car.features || '').replace(/"/g, '""')}"`,
                car.eco_badge,
                car.price,
                car.vat_deductible ? 'Ja' : 'Nein',
                car.seller,
                car.created_at
            ]);
            
            const csvContent = [
                headers.join(';'),
                ...rows.map(row => row.join(';'))
            ].join('\n');
            
            // Download file
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `fahrzeuge_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            hideLoading();
            showToast('Export erfolgreich', 'success');
        } catch (error) {
            hideLoading();
            showToast('Fehler beim Export: ' + error.message, 'error');
        }
    }

    // Toggle Stock Status
    document.querySelectorAll('.toggle-stock').forEach(badge => {
        badge.addEventListener('click', async function() {
            const carId = this.dataset.carId;
            const currentStatus = this.dataset.inStock === 'true';
            const newStatus = !currentStatus;
            
            showLoading();
            
            try {
                const response = await fetch(`/car/${carId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ in_stock: newStatus })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                hideLoading();
                
                // Update UI
                const row = document.querySelector(`tr[data-car-id="${carId}"]`);
                if (newStatus) {
                    // Now in stock
                    this.className = 'badge bg-success badge-stock toggle-stock';
                    this.innerHTML = '<i class="bi bi-check-circle me-1"></i>Im Bestand';
                    this.title = 'Klicken um als verkauft zu markieren';
                    row.classList.remove('sold-car');
                } else {
                    // Now sold
                    this.className = 'badge bg-danger badge-stock toggle-stock';
                    this.innerHTML = '<i class="bi bi-cart-check me-1"></i>Verkauft';
                    this.title = 'Klicken um als im Bestand zu markieren';
                    row.classList.add('sold-car');
                }
                this.dataset.inStock = newStatus.toString();
                
                showToast(newStatus ? 'Fahrzeug als "Im Bestand" markiert' : 'Fahrzeug als "Verkauft" markiert', 'success');
            } catch (error) {
                hideLoading();
                showToast('Fehler: ' + error.message, 'error');
            }
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Escape to close modals
        if (e.key === 'Escape') {
            editModal.hide();
            deleteModal.hide();
        }
    });
</script>
{% endblock %}
